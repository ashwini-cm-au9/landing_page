:
const express = require('express');
const tus = require('@tus/server');
const { Pool } = require('pg');

const app = express();
const pool = new Pool({
  user: 'your-username',
  host: 'your-host',
  database: 'your-database',
  password: 'your-password',
  port: 5432, // Replace with your PostgreSQL port if necessary
});

// Initialize tus server
const server = new tus.Server();
server.datastore = new tus.FileStore({
  path: '/uploads',
  getFilePath: (req, fileId, callback) => {
    pool.query('SELECT path FROM files WHERE id = $1', [fileId], (error, result) => {
      if (error) {
        return callback(error);
      }
      if (result.rows.length === 0) {
        return callback(new Error('File not found'));
      }
      callback(null, result.rows[0].path);
    });
  },
  setFilePath: (req, fileId, filePath, callback) => {
    pool.query('INSERT INTO files (id, path) VALUES ($1, $2)', [fileId, filePath], (error) => {
      callback(error);
    });
  },
  removeFilePath: (req, fileId, callback) => {
    pool.query('DELETE FROM files WHERE id = $1', [fileId], (error) => {
      callback(error);
    });
  },
});

// Enable CORS if necessary
// app.use(cors());

// Attach tus middleware
app.all('/files/*', tus.midware(server));

// Route to handle GET request for file data
app.get('/files/:fileId', (req, res) => {
  const fileId = req.params.fileId;
  pool.query('SELECT * FROM files WHERE id = $1', [fileId], (error, result) => {
    if (error) {
      console.error('Error retrieving file data', error);
      return res.status(500).json({ error: 'Internal server error' });
    }
    if (result.rows.length === 0) {
      return res.status(404).json({ error: 'File not found' });
    }
    const fileData = result.rows[0];
    res.json(fileData);
  });
});

app.listen(3000, () => {
  console.log('Server started on port 3000');
});

Create a context using the createContext function from React:

jsx

Copy code

import React, { createContext, useState } from 'react';

const FileUploadContext = createContext();

export default FileUploadContext;

In your component where you want to manage the file uploads, set up the state and dispatch functions using the useReducer hook:

jsx

Copy code

import React, { useReducer } from 'react';

import FileUploadContext from './FileUploadContext';

const initialState = {

  files: [],

};

function reducer(state, action) {

  switch (action.type) {

    case 'ADD_FILE':

      return {

        ...state,

        files: [...state.files, action.payload],

      };

    default:

      return state;

  }

}

function YourComponent() {

  const [state, dispatch] = useReducer(reducer, initialState);

  return (

    <FileUploadContext.Provider value={{ state, dispatch }}>

      {/* Your component code */}

    </FileUploadContext.Provider>

  );

}

export default YourComponent;

When you want to add a file upload, you can dispatch an action to add the file to the context state:

import React, { useContext } from 'react';

import FileUploadContext from './FileUploadContext';

function FileUploader() {

  const { dispatch } = useContext(FileUploadContext);

  const handleFileUpload = (file) => {

    dispatch({ type: 'ADD_FILE', payload: file });

    // Additional logic for uploading the file

  };

  return (

    <div>

      <input type="file" onChange={(e) => handleFileUpload(e.target.files[0])} />

    </div>

  );

}

export default FileUploader;

Now, to show the progress of files using tus-js-client and useContext, you can follow these steps:

Install the tus-js-client package:

shell

npm install tus-js-client

In your component, you can use the useEffect hook to set up tus-js-client and track the progress of each file upload:

jsx

import React, { useContext, useEffect } from 'react';

import tus from 'tus-js-client';

import FileUploadContext from './FileUploadContext';

function FileUploader() {

  const { state } = useContext(FileUploadContext);

  useEffect(() => {

    state.files.forEach((file) => {

      const upload = new tus.Upload(file, {

        endpoint: 'http://your-upload-endpoint',

        onError: (error) => {

          console.log('Upload error', error);

        },

        onProgress: (bytesUploaded, bytesTotal) => {

          const progress = Math.round((bytesUploaded / bytesTotal) * 100);

          console.log('Progress', progress);

          // You can update the progress in the context state here

        },

        onSuccess: () => {

          console.log('Upload success');

          // You can update the success state in the context if needed

        },

      });

      upload.start();

    });

  }, [state.files]);

  return (

    <div>

      <input type="file" onChange={(e) => handleFileUpload(e.target.files[0])} />

    </div>

  );

}

export default FileUploader;

In the above example, the onProgress callback logs the progress of each file upload. You can update the progress in the context state or perform any other action as needed. Similarly, the onSuccess callback logs a message when the upload is successful. You can customize these callbacks to suit your requirement
